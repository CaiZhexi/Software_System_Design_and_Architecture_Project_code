{% extends "layout-en.html" %}

{% block title %}Essay Review - Smart Education Platform{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">‚úçÔ∏è Essay Review</h1>
    <p class="page-subtitle">Submit your essay for professional feedback and suggestions</p>
</div>

<div class="essay-container">
    <!-- Input area -->
    <div>
        <div class="card">
            <h3 class="card-title" style="margin-bottom: var(--spacing-lg);">Submit Essay</h3>
            
            <form id="essayForm">
                <!-- Essay type -->
                <div class="input-group">
                    <label>Essay Type</label>
                    <div class="essay-type-select" id="typeSelect">
                        <span class="subject-option active" data-value="ËÆ∞ÂèôÊñá">üìñ Narrative</span>
                        <span class="subject-option" data-value="ËÆÆËÆ∫Êñá">üí≠ Argumentative</span>
                        <span class="subject-option" data-value="ËØ¥ÊòéÊñá">üìã Expository</span>
                        <span class="subject-option" data-value="Â∫îÁî®Êñá">üìù Practical</span>
                    </div>
                    <input type="hidden" name="essay_type" id="typeInput" value="ËÆ∞ÂèôÊñá">
                </div>
                
                <!-- Title -->
                <div class="input-group">
                    <label for="title">Essay Title</label>
                    <input type="text" class="input" name="title" id="title" placeholder="Enter essay title" required>
                </div>
                
                <!-- Content -->
                <div class="input-group">
                    <label for="content">Essay Content</label>
                    <textarea class="input" name="content" id="content" placeholder="Paste or type your essay content..." required style="min-height: 300px;"></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: 13px;">
                        <span>Recommended: 500-1000 words</span>
                        <span>Current count: <span id="wordCount">0</span></span>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary btn-lg" style="width: 100%;" id="submitBtn" onclick="submitEssay()">
                    <i class="fas fa-paper-plane"></i>
                    Submit for Review
                </button>
            </form>
        </div>
    </div>
    
    <!-- Result area -->
    <div>
        <div class="card" id="resultCard" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">üìä Review Results</h3>
            </div>
            
            <!-- Overall score -->
            <div class="score-circle">
                <span class="score-value" id="overallScore">0</span>
                <span class="score-label">Overall Score</span>
            </div>
            
            <!-- Topic Analysis -->
            <div class="feedback-section" style="background: linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,193,7,0.05) 100%); border-left: 4px solid var(--warning);">
                <div class="feedback-header">
                    <span class="feedback-title">
                        <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
                        Topic Analysis
                    </span>
                </div>
                <div id="topicAnalysisContent">
                    <!-- Possible themes -->
                    <div style="margin-bottom: var(--spacing-md);">
                        <h5 style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span style="color: var(--warning);">üìå</span> Possible Themes
                        </h5>
                        <ul id="possibleThemes" style="list-style: none; padding-left: 0;"></ul>
                    </div>
                    
                    <!-- Examiner's purpose -->
                    <div style="margin-bottom: var(--spacing-md);">
                        <h5 style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span style="color: var(--info);">üéØ</span> Examiner's Purpose
                        </h5>
                        <p id="examinerPurpose" style="color: var(--text-secondary); line-height: 1.8; padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);"></p>
                    </div>
                    
                    <!-- Key points -->
                    <div style="margin-bottom: var(--spacing-md);">
                        <h5 style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span style="color: var(--success);">‚ú®</span> Key Points to Highlight
                        </h5>
                        <p id="keyPoints" style="color: var(--text-secondary); line-height: 1.8; padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);"></p>
                    </div>
                    
                    <!-- Common mistakes -->
                    <div>
                        <h5 style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span style="color: var(--danger);">‚ö†Ô∏è</span> Common Misunderstandings
                        </h5>
                        <ul id="commonMistakes" style="list-style: none; padding-left: 0;"></ul>
                    </div>
                </div>
            </div>
            
            <!-- Structure -->
            <div class="feedback-section">
                <div class="feedback-header">
                    <span class="feedback-title">
                        <i class="fas fa-sitemap" style="color: var(--primary);"></i>
                        Structure
                    </span>
                    <span class="feedback-score" id="structureScore">-</span>
                </div>
                <p id="structureFeedback" style="color: var(--text-secondary); line-height: 1.8;"></p>
            </div>
            
            <!-- Grammar -->
            <div class="feedback-section">
                <div class="feedback-header">
                    <span class="feedback-title">
                        <i class="fas fa-spell-check" style="color: var(--secondary);"></i>
                        Grammar & Expression
                    </span>
                    <span class="feedback-score" id="grammarScore">-</span>
                </div>
                <p id="grammarFeedback" style="color: var(--text-secondary); line-height: 1.8;"></p>
            </div>
            
            <!-- Vocabulary -->
            <div class="feedback-section">
                <div class="feedback-header">
                    <span class="feedback-title">
                        <i class="fas fa-font" style="color: var(--purple);"></i>
                        Vocabulary
                    </span>
                    <span class="feedback-score" id="vocabularyScore">-</span>
                </div>
                <p id="vocabularyFeedback" style="color: var(--text-secondary); line-height: 1.8;"></p>
            </div>
            
            <!-- Overall feedback -->
            <div class="feedback-section" style="background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(78,205,196,0.1) 100%);">
                <div class="feedback-header">
                    <span class="feedback-title">
                        <i class="fas fa-star" style="color: var(--accent);"></i>
                        Overall Feedback
                    </span>
                </div>
                <p id="overallFeedback" style="color: var(--text-primary); line-height: 1.8; font-weight: 500;"></p>
            </div>
            
            <!-- Suggestions -->
            <div style="margin-top: var(--spacing-lg);">
                <h4 style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
                    Improvement Suggestions
                </h4>
                <ul id="suggestionsList" style="list-style: none;"></ul>
            </div>
            
            <button class="btn btn-secondary" style="width: 100%; margin-top: var(--spacing-xl);" onclick="location.reload()">
                <i class="fas fa-redo"></i>
                Review Another Essay
            </button>
        </div>
        
        <!-- Loading state -->
        <div class="card" id="loadingCard" style="display: none;">
            <div class="loading" style="padding: 80px;">
                <div class="loading-spinner"></div>
                <span class="loading-text">AI is reviewing your essay...</span>
            </div>
        </div>
        
        <!-- Initial prompt -->
        <div class="card" id="emptyCard">
            <div class="empty-state">
                <div class="empty-icon">üìù</div>
                <p class="empty-title">Submit your essay to start</p>
                <p class="empty-text">AI will evaluate your essay from multiple dimensions including structure, grammar, and vocabulary</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Type selection
const typeOptions = document.querySelectorAll('.essay-type-select .subject-option');
const typeInput = document.getElementById('typeInput');

typeOptions.forEach(option => {
    option.addEventListener('click', () => {
        typeOptions.forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        typeInput.value = option.dataset.value;
    });
});

// Word count
const contentInput = document.getElementById('content');
const wordCount = document.getElementById('wordCount');

contentInput.addEventListener('input', () => {
    wordCount.textContent = contentInput.value.length;
});

// Form submission
async function submitEssay() {
    const content = contentInput.value;
    if (content.length < 100) {
        showToast('Essay is too short, please enter at least 100 characters', 'warning');
        return;
    }
    
    const formData = new FormData(document.getElementById('essayForm'));
    
    // Display loading state
    document.getElementById('emptyCard').style.display = 'none';
    document.getElementById('resultCard').style.display = 'none';
    document.getElementById('loadingCard').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;
    
    try {
        const result = await api('/api/essay', {
            method: 'POST',
            body: formData
        });
        
        // Display result
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultCard').style.display = 'block';
        
        // Overall score
        document.getElementById('overallScore').textContent = result.overall_score || 0;
        
        // Topic analysis
        if (result.topic_analysis) {
            const ta = result.topic_analysis;
            
            // Possible themes
            const themesEl = document.getElementById('possibleThemes');
            if (ta.possible_themes && ta.possible_themes.length > 0) {
                themesEl.innerHTML = ta.possible_themes.map(theme => `
                    <li style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs); padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);">
                        <span style="color: var(--warning);">‚Ä¢</span>
                        <span style="color: var(--text-secondary);">${theme}</span>
                    </li>
                `).join('');
            } else {
                themesEl.innerHTML = '<li style="color: var(--text-secondary);">No data available</li>';
            }
            
            // Examiner's purpose
            document.getElementById('examinerPurpose').textContent = ta.examiner_purpose || 'No analysis available';
            
            // Key points
            document.getElementById('keyPoints').textContent = ta.key_points || 'No analysis available';
            
            // Common mistakes
            const mistakesEl = document.getElementById('commonMistakes');
            if (ta.common_mistakes && ta.common_mistakes.length > 0) {
                mistakesEl.innerHTML = ta.common_mistakes.map(mistake => `
                    <li style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs); padding: var(--spacing-sm) var(--spacing-md); background: rgba(239, 68, 68, 0.05); border-radius: var(--radius-sm); border-left: 3px solid var(--danger);">
                        <span style="color: var(--danger);">‚ö†</span>
                        <span style="color: var(--text-secondary);">${mistake}</span>
                    </li>
                `).join('');
            } else {
                mistakesEl.innerHTML = '<li style="color: var(--text-secondary);">No data available</li>';
            }
        }
        
        // Structure
        if (result.structure) {
            document.getElementById('structureScore').textContent = result.structure.score + ' pts';
            document.getElementById('structureFeedback').textContent = result.structure.feedback || '';
        }
        
        // Grammar
        if (result.grammar) {
            document.getElementById('grammarScore').textContent = result.grammar.score + ' pts';
            document.getElementById('grammarFeedback').textContent = result.grammar.feedback || '';
        }
        
        // Vocabulary
        if (result.vocabulary) {
            document.getElementById('vocabularyScore').textContent = result.vocabulary.score + ' pts';
            document.getElementById('vocabularyFeedback').textContent = result.vocabulary.feedback || '';
        }
        
        // Overall feedback
        document.getElementById('overallFeedback').textContent = result.overall_feedback || '';
        
        // Suggestions
        const suggestionsList = document.getElementById('suggestionsList');
        if (result.suggestions && result.suggestions.length > 0) {
            suggestionsList.innerHTML = result.suggestions.map((s, i) => `
                <li style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);">
                    <span style="color: var(--primary); font-weight: 600;">${i + 1}.</span>
                    <span>${s}</span>
                </li>
            `).join('');
        } else {
            suggestionsList.innerHTML = '<li style="color: var(--text-secondary);">No specific suggestions</li>';
        }
        
        showToast('Review complete!');
        
    } catch (error) {
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('emptyCard').style.display = 'block';
    }
    
    document.getElementById('submitBtn').disabled = false;
}
</script>
{% endblock %}
