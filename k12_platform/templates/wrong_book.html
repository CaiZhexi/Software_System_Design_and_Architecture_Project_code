{% extends "layout.html" %}

{% block title %}é”™é¢˜æœ¬ - æ™ºæ…§æ•™è‚²å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“• é”™é¢˜æœ¬</h1>
    <p class="page-subtitle">å›é¡¾é”™é¢˜ï¼Œå·©å›ºçŸ¥è¯†ç‚¹</p>
</div>

<div id="wrongBookContent">
    <div class="loading">
        <div class="loading-spinner"></div>
        <span class="loading-text">åŠ è½½ä¸­...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadWrongBook() {
    try {
        const wrongs = await api('/api/wrong-book');
        const container = document.getElementById('wrongBookContent');
        
        if (wrongs.length === 0) {
            container.innerHTML = `
                <div class="card">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‰</div>
                        <p class="empty-title">é”™é¢˜æœ¬æ˜¯ç©ºçš„</p>
                        <p class="empty-text">å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼Œä¸æ–­è¿›æ­¥ï¼</p>
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="wrong-book-grid">
                ${wrongs.map(w => `
                    <div class="card wrong-card" id="wrong-${w.id}">
                        <div class="wrong-card-header">
                            <span class="tag">${w.subject || 'æœªåˆ†ç±»'}</span>
                            <span class="wrong-subject">${new Date(w.created_at).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="wrong-content">
                            ${w.image_url ? `<img src="${w.image_url}" style="max-width: 100%; border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">` : ''}
                            ${w.content || 'å›¾ç‰‡é¢˜ç›®'}
                        </div>
                        
                        <div class="wrong-answer">
                            <div class="wrong-answer-label">æ­£ç¡®ç­”æ¡ˆ</div>
                            <div>${w.answer}</div>
                        </div>
                        
                        ${w.steps && w.steps.length > 0 ? `
                            <details style="margin-bottom: var(--spacing-md);">
                                <summary style="cursor: pointer; color: var(--primary); font-weight: 500;">æŸ¥çœ‹è§£é¢˜æ­¥éª¤</summary>
                                <ul class="steps-list" style="margin-top: var(--spacing-md);">
                                    ${w.steps.map((step, i) => `
                                        <li class="step-item">
                                            <span class="step-number">${i + 1}</span>
                                            <div class="step-content">${step}</div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </details>
                        ` : ''}
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-md);">
                            <span style="color: var(--text-secondary); font-size: 13px;">
                                å·²ç»ƒä¹  <strong>${w.practice_count}</strong> æ¬¡
                            </span>
                        </div>
                        
                        <div class="wrong-actions">
                            <button class="btn btn-secondary btn-sm" onclick="practice(${w.id})">
                                <i class="fas fa-redo"></i>
                                å†ç»ƒä¸€æ¬¡
                            </button>
                            <button class="btn btn-sm" style="background: var(--success); color: white;" onclick="master(${w.id})">
                                <i class="fas fa-check"></i>
                                å·²æŒæ¡
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error(error);
    }
}

async function practice(wrongId) {
    try {
        await api(`/api/wrong-book/practice/${wrongId}`, { method: 'POST' });
        showToast('å·²è®°å½•ç»ƒä¹ ï¼');
        loadWrongBook();
    } catch (error) {
        // é”™è¯¯å·²å¤„ç†
    }
}

async function master(wrongId) {
    try {
        await api(`/api/wrong-book/master/${wrongId}`, { method: 'POST' });
        showToast('å¤ªæ£’äº†ï¼å·²æ ‡è®°ä¸ºæŒæ¡ï¼', 'success');
        document.getElementById(`wrong-${wrongId}`).remove();
    } catch (error) {
        // é”™è¯¯å·²å¤„ç†
    }
}

loadWrongBook();
</script>
{% endblock %}
