{% extends "layout.html" %}

{% block title %}é”™é¢˜ç»ƒä¹  - æ™ºæ…§æ•™è‚²å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“ é”™é¢˜ç»ƒä¹ </h1>
    <p class="page-subtitle">ä¸“æ³¨ç»ƒä¹ ï¼Œå·©å›ºçŸ¥è¯†</p>
</div>

<!-- ç»ƒä¹ åŒºåŸŸ -->
<div class="practice-container" style="max-width: 900px; margin: 0 auto;">
    <!-- é¢˜ç›®å¡ç‰‡ -->
    <div class="card" id="questionCard">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">åŠ è½½ä¸­...</span>
        </div>
    </div>
    
    <!-- ç­”é¢˜åŒºåŸŸ -->
    <div class="card" id="answerCard" style="display: none; margin-top: var(--spacing-xl);">
        <h3 style="margin-bottom: var(--spacing-lg);">ğŸ’­ ä½ çš„ç­”æ¡ˆ</h3>
        <textarea 
            class="input" 
            id="userAnswer" 
            placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..." 
            style="min-height: 150px; font-size: 16px;"
        ></textarea>
        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
            <button class="btn btn-primary" onclick="submitAnswer()" style="flex: 1;">
                <i class="fas fa-check"></i>
                æäº¤ç­”æ¡ˆ
            </button>
            <button class="btn btn-secondary" onclick="showHint()" style="flex: 1;">
                <i class="fas fa-lightbulb"></i>
                è·å–æ€è·¯æç¤º
            </button>
        </div>
    </div>
    
    <!-- æ€è·¯æç¤º -->
    <div class="card" id="hintCard" style="display: none; margin-top: var(--spacing-xl); background: linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,193,7,0.05) 100%); border-left: 4px solid var(--warning);">
        <h3 style="margin-bottom: var(--spacing-md);">ğŸ’¡ è§£é¢˜æ€è·¯æç¤º</h3>
        <div id="hintContent" style="color: var(--text-secondary); line-height: 1.8;"></div>
    </div>
    
    <!-- çŸ¥è¯†ç‚¹è®²è§£ -->
    <div class="card" id="knowledgeCard" style="margin-top: var(--spacing-xl); background: linear-gradient(135deg, rgba(123,104,238,0.1) 0%, rgba(123,104,238,0.05) 100%); border-left: 4px solid var(--purple);">
        <h3 style="margin-bottom: var(--spacing-md);">ğŸ“š é‡ç‚¹çŸ¥è¯†è®²è§£</h3>
        <div id="knowledgeContent"></div>
    </div>
    
    <!-- ç­”æ¡ˆå¯¹æ¯” -->
    <div class="card" id="resultCard" style="display: none; margin-top: var(--spacing-xl);">
        <h3 style="margin-bottom: var(--spacing-lg);">ğŸ“Š ç­”æ¡ˆå¯¹æ¯”</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
            <div>
                <h4 style="color: var(--text-secondary); margin-bottom: var(--spacing-sm);">ä½ çš„ç­”æ¡ˆ</h4>
                <div id="userAnswerDisplay" style="padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-md); min-height: 100px;"></div>
            </div>
            <div>
                <h4 style="color: var(--success); margin-bottom: var(--spacing-sm);">æ­£ç¡®ç­”æ¡ˆ</h4>
                <div id="correctAnswerDisplay" style="padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-md); min-height: 100px;"></div>
            </div>
        </div>
        
        <!-- AIè¯„ä»· -->
        <div id="aiEvaluation" style="padding: var(--spacing-lg); background: var(--bg-primary); border-radius: var(--radius-md); border-left: 4px solid var(--info);">
            <h4 style="margin-bottom: var(--spacing-md);">ğŸ¤– AIè¯„ä»·</h4>
            <div id="evaluationContent" style="color: var(--text-secondary); line-height: 1.8;"></div>
        </div>
        
        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
            <button class="btn btn-secondary" onclick="retryQuestion()" style="flex: 1;">
                <i class="fas fa-redo"></i>
                é‡æ–°ç»ƒä¹ 
            </button>
            <button class="btn btn-primary" onclick="backToWrongBook()" style="flex: 1;">
                <i class="fas fa-arrow-left"></i>
                è¿”å›é”™é¢˜æœ¬
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentQuestion = null;
let wrongId = null;

// è·å–URLå‚æ•°
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// åŠ è½½é¢˜ç›®
async function loadQuestion() {
    wrongId = getQueryParam('id');
    if (!wrongId) {
        showToast('æœªæ‰¾åˆ°é¢˜ç›®ID', 'error');
        setTimeout(() => window.location.href = '/wrong-book', 1500);
        return;
    }
    
    try {
        const wrongs = await api('/api/wrong-book');
        currentQuestion = wrongs.find(w => w.id == wrongId);
        
        if (!currentQuestion) {
            showToast('é¢˜ç›®ä¸å­˜åœ¨', 'error');
            setTimeout(() => window.location.href = '/wrong-book', 1500);
            return;
        }
        
        renderQuestion();
    } catch (error) {
        console.error(error);
    }
}

// æ¸²æŸ“é¢˜ç›®
function renderQuestion() {
    const questionCard = document.getElementById('questionCard');
    const answerCard = document.getElementById('answerCard');
    
    questionCard.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border);">
            <span class="tag tag-primary" style="font-size: 14px;">${currentQuestion.subject || 'æœªåˆ†ç±»'}</span>
            <span style="color: var(--text-secondary); font-size: 14px;">ç»ƒä¹ æ¬¡æ•°ï¼š${currentQuestion.practice_count || 0}</span>
        </div>
        
        <h2 style="margin-bottom: var(--spacing-xl); font-size: 20px; line-height: 1.8;">
            ${currentQuestion.content || 'å›¾ç‰‡é¢˜ç›®'}
        </h2>
        
        ${currentQuestion.image_url ? `
            <img src="${currentQuestion.image_url}" style="max-width: 100%; border-radius: var(--radius-md); margin-bottom: var(--spacing-xl);">
        ` : ''}
        
        ${currentQuestion.knowledge_point ? `
            <div style="padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-md); margin-top: var(--spacing-lg);">
                <span style="color: var(--text-secondary); font-size: 14px;">ğŸ’¡ æ¶‰åŠçŸ¥è¯†ç‚¹ï¼š</span>
                <strong>${currentQuestion.knowledge_point}</strong>
            </div>
        ` : ''}
    `;
    
    answerCard.style.display = 'block';
    renderKnowledge();
}

// æ¸²æŸ“çŸ¥è¯†ç‚¹è®²è§£
function renderKnowledge() {
    const knowledgeContent = document.getElementById('knowledgeContent');
    if (currentQuestion.steps && currentQuestion.steps.length > 0) {
        knowledgeContent.innerHTML = `
            <ul class="steps-list">
                ${currentQuestion.steps.map((step, i) => `
                    <li class="step-item">
                        <span class="step-number">${i + 1}</span>
                        <div class="step-content">${step}</div>
                    </li>
                `).join('')}
            </ul>
        `;
    } else {
        knowledgeContent.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— è¯¦ç»†æ­¥éª¤</p>';
    }
}

// æ˜¾ç¤ºæ€è·¯æç¤º
function showHint() {
    const hintCard = document.getElementById('hintCard');
    const hintContent = document.getElementById('hintContent');
    
    if (hintCard.style.display === 'block') {
        hintCard.style.display = 'none';
        return;
    }
    
    // ä»è§£é¢˜æ­¥éª¤ä¸­æå–ç¬¬ä¸€æ­¥ä½œä¸ºæç¤º
    if (currentQuestion.steps && currentQuestion.steps.length > 0) {
        hintContent.innerHTML = `
            <p><strong>ç¬¬ä¸€æ­¥æç¤ºï¼š</strong></p>
            <p>${currentQuestion.steps[0]}</p>
            <p style="margin-top: var(--spacing-md); font-style: italic;">ğŸ’¡ å…ˆå°è¯•æ ¹æ®è¿™ä¸ªæç¤ºæ€è€ƒï¼Œå®åœ¨ä¸ä¼šå¯ä»¥æŸ¥çœ‹ä¸‹æ–¹çš„å®Œæ•´çŸ¥è¯†ç‚¹è®²è§£</p>
        `;
    } else {
        hintContent.innerHTML = '<p>æš‚æ— æ€è·¯æç¤ºï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹çŸ¥è¯†ç‚¹è®²è§£</p>';
    }
    
    hintCard.style.display = 'block';
}

// æäº¤ç­”æ¡ˆ
async function submitAnswer() {
    const userAnswer = document.getElementById('userAnswer').value.trim();
    
    if (!userAnswer) {
        showToast('è¯·è¾“å…¥ç­”æ¡ˆ', 'warning');
        return;
    }
    
    // æ˜¾ç¤ºç»“æœå¡ç‰‡
    const resultCard = document.getElementById('resultCard');
    const userAnswerDisplay = document.getElementById('userAnswerDisplay');
    const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
    const evaluationContent = document.getElementById('evaluationContent');
    
    userAnswerDisplay.textContent = userAnswer;
    correctAnswerDisplay.textContent = currentQuestion.answer;
    
    // ç®€å•å¯¹æ¯”åˆ¤æ–­
    const isCorrect = userAnswer.toLowerCase().includes(currentQuestion.answer.toLowerCase()) ||
                      currentQuestion.answer.toLowerCase().includes(userAnswer.toLowerCase());
    
    if (isCorrect) {
        evaluationContent.innerHTML = `
            <div style="color: var(--success); font-weight: 600; margin-bottom: var(--spacing-sm);">
                âœ… å›ç­”æ­£ç¡®ï¼
            </div>
            <p>ä½ çš„ç­”æ¡ˆä¸æ ‡å‡†ç­”æ¡ˆä¸€è‡´ï¼Œè¯´æ˜ä½ å·²ç»æŒæ¡äº†è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚ç»§ç»­ä¿æŒï¼</p>
        `;
    } else {
        evaluationContent.innerHTML = `
            <div style="color: var(--warning); font-weight: 600; margin-bottom: var(--spacing-sm);">
                âš ï¸ ç­”æ¡ˆæœ‰å·®å¼‚
            </div>
            <p>ä½ çš„ç­”æ¡ˆä¸æ ‡å‡†ç­”æ¡ˆä¸å®Œå…¨ä¸€è‡´ï¼Œå»ºè®®ä»”ç»†æŸ¥çœ‹ä¸Šæ–¹çš„çŸ¥è¯†ç‚¹è®²è§£ï¼Œç†è§£è§£é¢˜æ€è·¯ã€‚</p>
        `;
    }
    
    resultCard.style.display = 'block';
    resultCard.scrollIntoView({ behavior: 'smooth' });
    
    // è®°å½•ç»ƒä¹ æ¬¡æ•°
    try {
        await api(`/api/wrong-book/practice/${wrongId}`, { method: 'POST' });
    } catch (error) {
        console.error(error);
    }
}

// é‡æ–°ç»ƒä¹ 
function retryQuestion() {
    document.getElementById('userAnswer').value = '';
    document.getElementById('resultCard').style.display = 'none';
    document.getElementById('hintCard').style.display = 'none';
    document.getElementById('answerCard').scrollIntoView({ behavior: 'smooth' });
}

// è¿”å›é”™é¢˜æœ¬
function backToWrongBook() {
    window.location.href = '/wrong-book';
}

// é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
loadQuestion();
</script>
{% endblock %}
