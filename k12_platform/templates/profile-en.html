{% extends "layout-en.html" %}

{% block title %}Profile - Smart Education Platform{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ðŸ‘¤ Profile</h1>
    <p class="page-subtitle">Manage your personal information and learning preferences</p>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-xl);">
    <!-- Avatar card -->
    <div class="card" style="text-align: center;">
        <div style="width: 120px; height: 120px; margin: 0 auto var(--spacing-xl); background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; font-weight: 600;" id="avatarLetter">
            {{ user.username[0] | upper }}
        </div>
        <h2 style="margin-bottom: var(--spacing-sm);" id="displayUsername">{{ user.username }}</h2>
        <p style="color: var(--text-secondary);" id="displayGrade">Loading...</p>
        
        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-around;">
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="profileQuestions">-</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Questions Solved</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="profileEssays">-</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Essays Reviewed</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit information -->
    <div class="card">
        <h3 class="card-title" style="margin-bottom: var(--spacing-xl);">Edit Information</h3>
        
        <form id="profileForm">
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" class="input" id="email" name="email" placeholder="For password recovery">
            </div>
            
            <div class="input-group">
                <label for="grade">Grade</label>
                <select class="input" id="grade" name="grade">
                    <option value="">Select grade</option>
                    <option value="å°å­¦ä¸€å¹´çº§">Elementary 1st Grade</option>
                    <option value="å°å­¦äºŒå¹´çº§">Elementary 2nd Grade</option>
                    <option value="å°å­¦ä¸‰å¹´çº§">Elementary 3rd Grade</option>
                    <option value="å°å­¦å››å¹´çº§">Elementary 4th Grade</option>
                    <option value="å°å­¦äº”å¹´çº§">Elementary 5th Grade</option>
                    <option value="å°å­¦å…­å¹´çº§">Elementary 6th Grade</option>
                    <option value="åˆä¸­ä¸€å¹´çº§">Middle School 7th Grade</option>
                    <option value="åˆä¸­äºŒå¹´çº§">Middle School 8th Grade</option>
                    <option value="åˆä¸­ä¸‰å¹´çº§">Middle School 9th Grade</option>
                    <option value="é«˜ä¸­ä¸€å¹´çº§">High School 10th Grade</option>
                    <option value="é«˜ä¸­äºŒå¹´çº§">High School 11th Grade</option>
                    <option value="é«˜ä¸­ä¸‰å¹´çº§">High School 12th Grade</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Preferred Subjects</label>
                <div class="subject-select" id="subjectSelect">
                    <span class="subject-option" data-value="æ•°å­¦">Math</span>
                    <span class="subject-option" data-value="è¯­æ–‡">Chinese</span>
                    <span class="subject-option" data-value="è‹±è¯­">English</span>
                    <span class="subject-option" data-value="ç‰©ç†">Physics</span>
                    <span class="subject-option" data-value="åŒ–å­¦">Chemistry</span>
                    <span class="subject-option" data-value="ç”Ÿç‰©">Biology</span>
                </div>
                <input type="hidden" id="subjects" name="subjects">
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedSubjects = [];

// Load profile
async function loadProfile() {
    try {
        const profile = await api('/api/profile');
        
        document.getElementById('email').value = profile.email || '';
        document.getElementById('grade').value = profile.grade || '';
        document.getElementById('displayGrade').textContent = profile.grade || 'Grade not set';
        
        // Subjects
        if (profile.subjects) {
            selectedSubjects = profile.subjects.split(',').filter(s => s);
            document.querySelectorAll('.subject-option').forEach(opt => {
                if (selectedSubjects.includes(opt.dataset.value)) {
                    opt.classList.add('active');
                }
            });
            document.getElementById('subjects').value = profile.subjects;
        }
        
        // Load statistics
        const stats = await api('/api/statistics');
        document.getElementById('profileQuestions').textContent = stats.total_questions;
        document.getElementById('profileEssays').textContent = stats.essay_count;
        
    } catch (error) {
        console.error(error);
    }
}

// Subject selection
document.querySelectorAll('.subject-option').forEach(option => {
    option.addEventListener('click', () => {
        const value = option.dataset.value;
        if (option.classList.contains('active')) {
            option.classList.remove('active');
            selectedSubjects = selectedSubjects.filter(s => s !== value);
        } else {
            option.classList.add('active');
            selectedSubjects.push(value);
        }
        document.getElementById('subjects').value = selectedSubjects.join(',');
    });
});

// Save
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        await api('/api/profile', {
            method: 'POST',
            body: formData
        });
        showToast('Saved successfully!');
        
        // Update display
        document.getElementById('displayGrade').textContent = formData.get('grade') || 'Grade not set';
    } catch (error) {
        // Error already handled
    }
});

loadProfile();
</script>
{% endblock %}
