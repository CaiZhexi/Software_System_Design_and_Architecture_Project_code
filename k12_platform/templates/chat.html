{% extends "layout.html" %}

{% block title %}å­¦ä¹ åŠ©æ‰‹ - æ™ºæ…§æ•™è‚²å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ’¬ å­¦ä¹ åŠ©æ‰‹</h1>
    <p class="page-subtitle">æœ‰é—®é¢˜å°½ç®¡é—®ï¼Œæˆ‘æ˜¯ä½ çš„ä¸“å±å­¦ä¹ ä¼™ä¼´</p>
</div>

<div class="chat-container">
    <!-- ä¼šè¯åˆ—è¡¨ -->
    <div class="chat-sessions">
        <button class="btn btn-primary" style="width: 100%; margin-bottom: var(--spacing-md);" onclick="newSession()">
            <i class="fas fa-plus"></i>
            æ–°å¯¹è¯
        </button>
        <div id="sessionList">
            <!-- ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
        </div>
    </div>
    
    <!-- èŠå¤©ä¸»åŒºåŸŸ -->
    <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="chat-message assistant">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å­¦ä¹ åŠ©æ‰‹ ğŸ“<br><br>
                    æˆ‘å¯ä»¥å¸®ä½ ï¼š<br>
                    â€¢ è§£ç­”å­¦ä¹ ä¸Šçš„ç–‘é—®<br>
                    â€¢ åˆ¶å®šå­¦ä¹ è®¡åˆ’<br>
                    â€¢ æä¾›å­¦ä¹ æ–¹æ³•å»ºè®®<br>
                    â€¢ èŠèŠç”Ÿæ´»ä¸­çš„å›°æƒ‘<br><br>
                    æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Œå°½ç®¡è¯´å§ï¼
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <input type="text" class="input" id="messageInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="if(event.key==='Enter')sendMessage()">
            <button class="btn btn-primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
                å‘é€
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSessionId = null;

// åŠ è½½ä¼šè¯åˆ—è¡¨
async function loadSessions() {
    try {
        const sessions = await api('/api/chat/sessions');
        const container = document.getElementById('sessionList');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: var(--spacing-md);">æš‚æ— å†å²å¯¹è¯</p>';
            return;
        }
        
        container.innerHTML = sessions.map(s => `
            <div class="chat-session-item ${s.id === currentSessionId ? 'active' : ''}" onclick="loadSession(${s.id})">
                <div class="chat-session-title">${s.title}</div>
                <div class="chat-session-time">${new Date(s.created_at).toLocaleDateString()}</div>
            </div>
        `).join('');
    } catch (error) {
        console.error(error);
    }
}

// åŠ è½½ä¼šè¯æ¶ˆæ¯
async function loadSession(sessionId) {
    currentSessionId = sessionId;
    loadSessions(); // æ›´æ–°é€‰ä¸­çŠ¶æ€
    
    try {
        const messages = await api(`/api/chat/messages/${sessionId}`);
        const container = document.getElementById('chatMessages');
        
        container.innerHTML = messages.map(m => `
            <div class="chat-message ${m.role}">
                <div class="message-avatar">${m.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
                <div class="message-content">${formatMessage(m.content)}</div>
            </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
    } catch (error) {
        console.error(error);
    }
}

// æ–°å¯¹è¯
function newSession() {
    currentSessionId = null;
    document.getElementById('chatMessages').innerHTML = `
        <div class="chat-message assistant">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
                ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å­¦ä¹ åŠ©æ‰‹ ğŸ“<br><br>
                æˆ‘å¯ä»¥å¸®ä½ ï¼š<br>
                â€¢ è§£ç­”å­¦ä¹ ä¸Šçš„ç–‘é—®<br>
                â€¢ åˆ¶å®šå­¦ä¹ è®¡åˆ’<br>
                â€¢ æä¾›å­¦ä¹ æ–¹æ³•å»ºè®®<br>
                â€¢ èŠèŠç”Ÿæ´»ä¸­çš„å›°æƒ‘<br><br>
                æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Œå°½ç®¡è¯´å§ï¼
            </div>
        </div>
    `;
    loadSessions();
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    const container = document.getElementById('chatMessages');
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    container.innerHTML += `
        <div class="chat-message user">
            <div class="message-avatar">ğŸ‘¤</div>
            <div class="message-content">${escapeHtml(message)}</div>
        </div>
    `;
    
    input.value = '';
    container.scrollTop = container.scrollHeight;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingId = 'loading-' + Date.now();
    container.innerHTML += `
        <div class="chat-message assistant" id="${loadingId}">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
                <div class="loading" style="padding: 0;">
                    <div class="loading-spinner" style="width: 20px; height: 20px;"></div>
                    <span class="loading-text" style="font-size: 14px;">æ€è€ƒä¸­...</span>
                </div>
            </div>
        </div>
    `;
    container.scrollTop = container.scrollHeight;
    
    try {
        const result = await api('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            })
        });
        
        currentSessionId = result.session_id;
        
        // æ›¿æ¢åŠ è½½çŠ¶æ€
        document.getElementById(loadingId).outerHTML = `
            <div class="chat-message assistant">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">${formatMessage(result.response)}</div>
            </div>
        `;
        
        container.scrollTop = container.scrollHeight;
        loadSessions();
        
    } catch (error) {
        document.getElementById(loadingId).remove();
    }
}

// æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆMarkdownæ¸²æŸ“ï¼‰
function formatMessage(text) {
    // ä½¿ç”¨å…¨å±€renderMarkdownå‡½æ•°è¿›è¡ŒMarkdownæ¸²æŸ“
    return renderMarkdown(text);
}

// HTMLè½¬ä¹‰ï¼ˆç”¨äºç”¨æˆ·è¾“å…¥ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// åˆå§‹åŒ–
loadSessions();
</script>
{% endblock %}
