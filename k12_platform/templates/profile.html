{% extends "layout.html" %}

{% block title %}ä¸ªäººä¸­å¿ƒ - æ™ºæ…§æ•™è‚²å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</h1>
    <p class="page-subtitle">ç®¡ç†ä½ çš„ä¸ªäººä¿¡æ¯å’Œå­¦ä¹ åå¥½</p>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-xl);">
    <!-- å¤´åƒå¡ç‰‡ -->
    <div class="card" style="text-align: center;">
        <div style="width: 120px; height: 120px; margin: 0 auto var(--spacing-xl); background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; font-weight: 600;" id="avatarLetter">
            {{ user.username[0] | upper }}
        </div>
        <h2 style="margin-bottom: var(--spacing-sm);" id="displayUsername">{{ user.username }}</h2>
        <p style="color: var(--text-secondary);" id="displayGrade">åŠ è½½ä¸­...</p>
        
        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-around;">
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="profileQuestions">-</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">è§£ç­”é¢˜ç›®</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="profileEssays">-</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">æ‰¹æ”¹ä½œæ–‡</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¿¡æ¯ç¼–è¾‘ -->
    <div class="card">
        <h3 class="card-title" style="margin-bottom: var(--spacing-xl);">ç¼–è¾‘ä¿¡æ¯</h3>
        
        <form id="profileForm">
            <div class="input-group">
                <label for="email">é‚®ç®±</label>
                <input type="email" class="input" id="email" name="email" placeholder="ç”¨äºæ‰¾å›å¯†ç ">
            </div>
            
            <div class="input-group">
                <label for="grade">å¹´çº§</label>
                <select class="input" id="grade" name="grade">
                    <option value="">é€‰æ‹©å¹´çº§</option>
                    <option value="å°å­¦ä¸€å¹´çº§">å°å­¦ä¸€å¹´çº§</option>
                    <option value="å°å­¦äºŒå¹´çº§">å°å­¦äºŒå¹´çº§</option>
                    <option value="å°å­¦ä¸‰å¹´çº§">å°å­¦ä¸‰å¹´çº§</option>
                    <option value="å°å­¦å››å¹´çº§">å°å­¦å››å¹´çº§</option>
                    <option value="å°å­¦äº”å¹´çº§">å°å­¦äº”å¹´çº§</option>
                    <option value="å°å­¦å…­å¹´çº§">å°å­¦å…­å¹´çº§</option>
                    <option value="åˆä¸­ä¸€å¹´çº§">åˆä¸­ä¸€å¹´çº§</option>
                    <option value="åˆä¸­äºŒå¹´çº§">åˆä¸­äºŒå¹´çº§</option>
                    <option value="åˆä¸­ä¸‰å¹´çº§">åˆä¸­ä¸‰å¹´çº§</option>
                    <option value="é«˜ä¸­ä¸€å¹´çº§">é«˜ä¸­ä¸€å¹´çº§</option>
                    <option value="é«˜ä¸­äºŒå¹´çº§">é«˜ä¸­äºŒå¹´çº§</option>
                    <option value="é«˜ä¸­ä¸‰å¹´çº§">é«˜ä¸­ä¸‰å¹´çº§</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>åå¥½å­¦ç§‘</label>
                <div class="subject-select" id="subjectSelect">
                    <span class="subject-option" data-value="æ•°å­¦">æ•°å­¦</span>
                    <span class="subject-option" data-value="è¯­æ–‡">è¯­æ–‡</span>
                    <span class="subject-option" data-value="è‹±è¯­">è‹±è¯­</span>
                    <span class="subject-option" data-value="ç‰©ç†">ç‰©ç†</span>
                    <span class="subject-option" data-value="åŒ–å­¦">åŒ–å­¦</span>
                    <span class="subject-option" data-value="ç”Ÿç‰©">ç”Ÿç‰©</span>
                </div>
                <input type="hidden" id="subjects" name="subjects">
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                <i class="fas fa-save"></i>
                ä¿å­˜ä¿®æ”¹
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedSubjects = [];

// åŠ è½½ç”¨æˆ·ä¿¡æ¯
async function loadProfile() {
    try {
        const profile = await api('/api/profile');
        
        document.getElementById('email').value = profile.email || '';
        document.getElementById('grade').value = profile.grade || '';
        document.getElementById('displayGrade').textContent = profile.grade || 'æœªè®¾ç½®å¹´çº§';
        
        // å­¦ç§‘
        if (profile.subjects) {
            selectedSubjects = profile.subjects.split(',').filter(s => s);
            document.querySelectorAll('.subject-option').forEach(opt => {
                if (selectedSubjects.includes(opt.dataset.value)) {
                    opt.classList.add('active');
                }
            });
            document.getElementById('subjects').value = profile.subjects;
        }
        
        // åŠ è½½ç»Ÿè®¡
        const stats = await api('/api/statistics');
        document.getElementById('profileQuestions').textContent = stats.total_questions;
        document.getElementById('profileEssays').textContent = stats.essay_count;
        
    } catch (error) {
        console.error(error);
    }
}

// å­¦ç§‘é€‰æ‹©
document.querySelectorAll('.subject-option').forEach(option => {
    option.addEventListener('click', () => {
        const value = option.dataset.value;
        if (option.classList.contains('active')) {
            option.classList.remove('active');
            selectedSubjects = selectedSubjects.filter(s => s !== value);
        } else {
            option.classList.add('active');
            selectedSubjects.push(value);
        }
        document.getElementById('subjects').value = selectedSubjects.join(',');
    });
});

// ä¿å­˜
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        await api('/api/profile', {
            method: 'POST',
            body: formData
        });
        showToast('ä¿å­˜æˆåŠŸï¼');
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('displayGrade').textContent = formData.get('grade') || 'æœªè®¾ç½®å¹´çº§';
    } catch (error) {
        // é”™è¯¯å·²å¤„ç†
    }
});

loadProfile();
</script>
{% endblock %}
