{% extends "layout.html" %}

{% block title %}å­¦ä¹ ç»Ÿè®¡ - æ™ºæ…§æ•™è‚²å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h1>
    <p class="page-subtitle">äº†è§£ä½ çš„å­¦ä¹ æƒ…å†µï¼Œå‘ç°è¿›æ­¥ç©ºé—´</p>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-icon primary">ğŸ“</div>
        <div class="stat-value" id="totalQuestions">-</div>
        <div class="stat-label">æ€»é¢˜ç›®æ•°</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">âœ…</div>
        <div class="stat-value" id="accuracyRate">-</div>
        <div class="stat-label">æ­£ç¡®ç‡</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning">ğŸ“•</div>
        <div class="stat-value" id="wrongCount">-</div>
        <div class="stat-label">å¾…æŒæ¡é”™é¢˜</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon info">âœï¸</div>
        <div class="stat-value" id="essayCount">-</div>
        <div class="stat-label">ä½œæ–‡æ‰¹æ”¹</div>
    </div>
</div>

<div class="charts-row">
    <!-- ä½œæ–‡åˆ†æ•° -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ“ˆ å­¦ä¹ æ¦‚è§ˆ</h3>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-lg);">
            <div style="text-align: center; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(255,107,53,0.05) 100%); border-radius: var(--radius-lg);">
                <div style="font-size: 42px; font-weight: 700; color: var(--primary);" id="recentQuestions">-</div>
                <div style="color: var(--text-secondary);">æœ¬å‘¨åšé¢˜</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(0,184,148,0.1) 0%, rgba(0,184,148,0.05) 100%); border-radius: var(--radius-lg);">
                <div style="font-size: 42px; font-weight: 700; color: var(--success);" id="masteredCount">-</div>
                <div style="color: var(--text-secondary);">å·²æŒæ¡</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(123,104,238,0.1) 0%, rgba(123,104,238,0.05) 100%); border-radius: var(--radius-lg);">
                <div style="font-size: 42px; font-weight: 700; color: var(--purple);" id="avgEssayScore">-</div>
                <div style="color: var(--text-secondary);">ä½œæ–‡å¹³å‡åˆ†</div>
            </div>
        </div>
    </div>
    
    <!-- è–„å¼±çŸ¥è¯†ç‚¹ -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">âš ï¸ è–„å¼±çŸ¥è¯†ç‚¹</h3>
        </div>
        <ul class="weak-points-list" id="weakPointsList">
            <li class="weak-point-item">
                <span class="weak-point-name">åŠ è½½ä¸­...</span>
            </li>
        </ul>
    </div>
</div>

<!-- æ¨èç»ƒä¹  -->
<div class="card" style="margin-top: var(--spacing-xl);">
    <div class="card-header">
        <h3 class="card-title">ğŸ¯ æ¨èç»ƒä¹ </h3>
        <button class="btn btn-ghost btn-sm" onclick="loadRecommendations()">
            <i class="fas fa-sync"></i>
            æ¢ä¸€æ‰¹
        </button>
    </div>
    <div id="recommendList">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">ç”Ÿæˆæ¨èä¸­...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStats() {
    try {
        const stats = await api('/api/statistics');
        
        document.getElementById('totalQuestions').textContent = stats.total_questions;
        document.getElementById('accuracyRate').textContent = stats.accuracy_rate + '%';
        document.getElementById('wrongCount').textContent = stats.wrong_count;
        document.getElementById('essayCount').textContent = stats.essay_count;
        document.getElementById('recentQuestions').textContent = stats.recent_questions;
        document.getElementById('masteredCount').textContent = stats.mastered_count;
        document.getElementById('avgEssayScore').textContent = stats.avg_essay_score || '-';
        
        // è–„å¼±çŸ¥è¯†ç‚¹
        const weakList = document.getElementById('weakPointsList');
        if (stats.weak_points.length > 0) {
            weakList.innerHTML = stats.weak_points.map(wp => `
                <li class="weak-point-item">
                    <span class="weak-point-name">${wp.name}</span>
                    <span class="weak-point-count">${wp.count}é¢˜</span>
                </li>
            `).join('');
        } else {
            weakList.innerHTML = '<li class="weak-point-item"><span class="weak-point-name" style="color: var(--success);">æš‚æ— è–„å¼±çŸ¥è¯†ç‚¹ ğŸ‘</span></li>';
        }
    } catch (error) {
        console.error(error);
    }
}

// åŠ è½½æ¨è
async function loadRecommendations() {
    const container = document.getElementById('recommendList');
    container.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">ç”Ÿæˆæ¨èä¸­...</span>
        </div>
    `;
    
    try {
        const exercises = await api('/api/recommend');
        
        if (exercises.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: var(--spacing-lg);">
                    <p class="empty-text">æš‚æ— æ¨èç»ƒä¹ ï¼Œç»§ç»­åŠªåŠ›å­¦ä¹ å§ï¼</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = exercises.map((ex, i) => `
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <span style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">${i + 1}</span>
                    <div style="flex: 1;">
                        <p style="margin-bottom: var(--spacing-md); line-height: 1.7;">${ex.question}</p>
                        ${ex.options ? `
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                                ${ex.options.map(opt => `<div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);">${opt}</div>`).join('')}
                            </div>
                        ` : ''}
                        <details>
                            <summary style="cursor: pointer; color: var(--primary); font-weight: 500;">æŸ¥çœ‹ç­”æ¡ˆ</summary>
                            <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-md);">
                                <p><strong>ç­”æ¡ˆï¼š</strong>${ex.answer}</p>
                                <p style="margin-top: var(--spacing-sm); color: var(--text-secondary);">${ex.explanation}</p>
                            </div>
                        </details>
                        <div style="margin-top: var(--spacing-sm);">
                            <span class="tag tag-info">${ex.knowledge_point}</span>
                            <span class="tag" style="margin-left: var(--spacing-xs);">éš¾åº¦ ${'â­'.repeat(ex.difficulty || 3)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <p class="empty-text">åŠ è½½æ¨èå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
            </div>
        `;
    }
}

// ç¡®ä¿åœ¨windowåŠ è½½å®Œæˆåæ‰§è¡Œ
if (document.readyState === 'complete') {
    loadStats();
    loadRecommendations();
} else {
    window.addEventListener('load', function() {
        loadStats();
        loadRecommendations();
    });
}
</script>
{% endblock %}
