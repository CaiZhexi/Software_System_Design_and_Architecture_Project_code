{% extends "layout-en.html" %}

{% block title %}Statistics - Smart Education Platform{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üìä Learning Statistics</h1>
    <p class="page-subtitle">Understand your learning progress and discover areas for improvement</p>
</div>

<!-- Statistics cards -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-icon primary">üìù</div>
        <div class="stat-value" id="totalQuestions">-</div>
        <div class="stat-label">Total Questions</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">‚úÖ</div>
        <div class="stat-value" id="accuracyRate">-</div>
        <div class="stat-label">Accuracy Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning">üìï</div>
        <div class="stat-value" id="wrongCount">-</div>
        <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon info">‚úçÔ∏è</div>
        <div class="stat-value" id="essayCount">-</div>
        <div class="stat-label">Essays Reviewed</div>
    </div>
</div>

<div class="charts-row">
    <!-- Learning overview -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üìà Learning Overview</h3>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-lg);">
            <div style="text-align: center; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(255,107,53,0.05) 100%); border-radius: var(--radius-lg);">
                <div style="font-size: 42px; font-weight: 700; color: var(--primary);" id="recentQuestions">-</div>
                <div style="color: var(--text-secondary);">This Week</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(0,184,148,0.1) 0%, rgba(0,184,148,0.05) 100%); border-radius: var(--radius-lg);">
                <div style="font-size: 42px; font-weight: 700; color: var(--success);" id="masteredCount">-</div>
                <div style="color: var(--text-secondary);">Mastered</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(123,104,238,0.1) 0%, rgba(123,104,238,0.05) 100%); border-radius: var(--radius-lg);">
                <div style="font-size: 42px; font-weight: 700; color: var(--purple);" id="avgEssayScore">-</div>
                <div style="color: var(--text-secondary);">Avg Essay Score</div>
            </div>
        </div>
    </div>
    
    <!-- Weak points -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">‚ö†Ô∏è Weak Points</h3>
        </div>
        <ul class="weak-points-list" id="weakPointsList">
            <li class="weak-point-item">
                <span class="weak-point-name">Loading...</span>
            </li>
        </ul>
    </div>
</div>

<!-- Subject radar chart -->
<div class="card" style="margin-top: var(--spacing-xl);">
    <div class="card-header">
        <h3 class="card-title">üìä Subject Performance Analysis</h3>
        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Analysis based on historical question data for each subject</p>
    </div>
    <div style="padding: var(--spacing-xl); display: flex; justify-content: center; align-items: center;">
        <div style="width: 100%; max-width: 600px; position: relative; height: 500px;">
            <canvas id="subjectRadarChart"></canvas>
        </div>
    </div>
</div>

<!-- Recommended practice -->
<div class="card" style="margin-top: var(--spacing-xl);">
    <div class="card-header">
        <h3 class="card-title">üéØ Recommended Practice</h3>
        <button class="btn btn-ghost btn-sm" onclick="loadRecommendations()">
            <i class="fas fa-sync"></i>
            Refresh
        </button>
    </div>
    <div id="recommendList">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">Generating recommendations...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load statistics
async function loadStats() {
    try {
        const stats = await api('/api/statistics');
        
        document.getElementById('totalQuestions').textContent = stats.total_questions;
        document.getElementById('accuracyRate').textContent = stats.accuracy_rate + '%';
        document.getElementById('wrongCount').textContent = stats.wrong_count;
        document.getElementById('essayCount').textContent = stats.essay_count;
        document.getElementById('recentQuestions').textContent = stats.recent_questions;
        document.getElementById('masteredCount').textContent = stats.mastered_count;
        document.getElementById('avgEssayScore').textContent = stats.avg_essay_score !== undefined ? stats.avg_essay_score : '-';
        
        // Weak points
        const weakList = document.getElementById('weakPointsList');
        if (stats.weak_points.length > 0) {
            weakList.innerHTML = stats.weak_points.map(wp => `
                <li class="weak-point-item">
                    <span class="weak-point-name">${wp.name}</span>
                    <span class="weak-point-count">${wp.count} questions</span>
                </li>
            `).join('');
        } else {
            weakList.innerHTML = '<li class="weak-point-item"><span class="weak-point-name" style="color: var(--success);">No weak points üëç</span></li>';
        }
    } catch (error) {
        console.error(error);
    }
}

// Load recommendations
async function loadRecommendations() {
    const container = document.getElementById('recommendList');
    container.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">Generating recommendations...</span>
        </div>
    `;
    
    try {
        const result = await api('/api/recommend');
        const exercises = result.questions || result;
        
        if (!exercises || exercises.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: var(--spacing-lg);">
                    <p class="empty-text">No recommendations available, keep learning!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = exercises.map((ex, i) => `
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <span style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">${i + 1}</span>
                    <div style="flex: 1;">
                        <p style="margin-bottom: var(--spacing-md); line-height: 1.7;">${ex.question}</p>
                        ${ex.options ? `
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                                ${ex.options.map(opt => `<div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);">${opt}</div>`).join('')}
                            </div>
                        ` : ''}
                        <details>
                            <summary style="cursor: pointer; color: var(--primary); font-weight: 500;">View Answer</summary>
                            <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-md);">
                                <p><strong>Answer:</strong> ${ex.answer}</p>
                                <p style="margin-top: var(--spacing-sm); color: var(--text-secondary);">${ex.explanation}</p>
                            </div>
                        </details>
                        <div style="margin-top: var(--spacing-sm);">
                            <span class="tag tag-info">${ex.knowledge_point}</span>
                            <span class="tag" style="margin-left: var(--spacing-xs);">Difficulty ${'‚≠ê'.repeat(ex.difficulty || 3)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <p class="empty-text">Failed to load recommendations, please try again later</p>
            </div>
        `;
    }
}

// Initialize subject radar chart
function initSubjectRadarChart() {
    const ctx = document.getElementById('subjectRadarChart');
    if (!ctx) return;
    
    // Static example data - 8 subjects' predicted scores
    const subjectData = {
        labels: ['Chinese', 'Math', 'English', 'Physics', 'Chemistry', 'Biology', 'History', 'Geography'],
        datasets: [{
            label: 'Current Level',
            data: [85, 92, 88, 78, 82, 90, 86, 84], // Example data, max 100
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgb(54, 162, 235)',
            pointBackgroundColor: 'rgb(54, 162, 235)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(54, 162, 235)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    };
    
    const config = {
        type: 'radar',
        data: subjectData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    angleLines: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    suggestedMin: 0,
                    suggestedMax: 100,
                    ticks: {
                        stepSize: 20,
                        font: {
                            size: 12
                        },
                        backdropColor: 'rgba(255, 255, 255, 0.8)'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    pointLabels: {
                        font: {
                            size: 14,
                            weight: '500'
                        },
                        color: '#333'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 13,
                            weight: '500'
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.r + ' pts';
                        }
                    }
                }
            }
        }
    };
    
    new Chart(ctx, config);
}

// Execute directly (script is at bottom of DOM, so DOM is ready)
loadStats();
loadRecommendations();
initSubjectRadarChart();
</script>
{% endblock %}
