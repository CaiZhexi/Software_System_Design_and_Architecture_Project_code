{% extends "layout-en.html" %}

{% block title %}Wrong Book - Smart Education Platform{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ðŸ“• Wrong Book</h1>
    <p class="page-subtitle">Review mistakes and consolidate knowledge</p>
</div>

<!-- Search and filter bar -->
<div class="card" style="margin-bottom: var(--spacing-xl);">
    <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
        <!-- Search box -->
        <div style="flex: 1; min-width: 250px;">
            <div class="input-group">
                <div style="position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: var(--spacing-md); top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                    <input 
                        type="text" 
                        class="input" 
                        id="searchInput" 
                        placeholder="Search content or knowledge points..." 
                        style="padding-left: 40px;"
                        oninput="filterWrongBook()"
                    >
                </div>
            </div>
        </div>
        
        <!-- Subject filter -->
        <div style="min-width: 150px;">
            <select class="input" id="subjectFilter" onchange="filterWrongBook()" style="cursor: pointer;">
                <option value="">All Subjects</option>
                <option value="æ•°å­¦">Math</option>
                <option value="è¯­æ–‡">Chinese</option>
                <option value="è‹±è¯­">English</option>
                <option value="ç‰©ç†">Physics</option>
                <option value="åŒ–å­¦">Chemistry</option>
                <option value="ç”Ÿç‰©">Biology</option>
                <option value="åŽ†å²">History</option>
                <option value="åœ°ç†">Geography</option>
                <option value="æ”¿æ²»">Politics</option>
            </select>
        </div>
        
        <!-- Clear filter -->
        <button class="btn btn-ghost" onclick="clearFilter()" style="white-space: nowrap;">
            <i class="fas fa-times"></i>
            Clear Filter
        </button>
    </div>
    
    <!-- Statistics info -->
    <div id="filterStats" style="margin-top: var(--spacing-md); color: var(--text-secondary); font-size: 14px;"></div>
</div>

<div id="wrongBookContent">
    <div class="loading">
        <div class="loading-spinner"></div>
        <span class="loading-text">Loading...</span>
    </div>
</div>

<!-- Mastered questions section -->
<div class="card" id="masteredSection" style="margin-top: var(--spacing-xl); display: none;">
    <div class="card-header" style="cursor: pointer;" onclick="toggleMastered()">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">âœ… Mastered Questions (<span id="masteredCount">0</span>)</h3>
            <i class="fas fa-chevron-down" id="masteredToggleIcon"></i>
        </div>
    </div>
    <div id="masteredContent" style="display: none;">
        <div id="masteredList"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variable to store all wrong questions
let allWrongQuestions = [];

async function loadWrongBook() {
    try {
        allWrongQuestions = await api('/api/wrong-book');
        renderWrongBook(allWrongQuestions);
        updateFilterStats(allWrongQuestions.length, allWrongQuestions.length);
    } catch (error) {
        console.error(error);
    }
}

// Render wrong questions list
function renderWrongBook(wrongs) {
    const container = document.getElementById('wrongBookContent');
    
    if (wrongs.length === 0) {
        container.innerHTML = `
            <div class="card">
                <div class="empty-state">
                    <div class="empty-icon">ðŸŽ‰</div>
                    <p class="empty-title">No questions found</p>
                    <p class="empty-text">Try adjusting the search criteria</p>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="wrong-book-grid">
            ${wrongs.map(w => `
                <div class="card wrong-card" id="wrong-${w.id}" data-subject="${w.subject || ''}" data-content="${(w.content || '').toLowerCase()}" data-knowledge="${(w.knowledge_point || '').toLowerCase()}">
                    <div class="wrong-card-header">
                        <span class="tag">${w.subject || 'Uncategorized'}</span>
                        <span class="wrong-subject">${new Date(w.created_at).toLocaleDateString()}</span>
                    </div>
                    
                    <div class="wrong-content">
                        ${w.image_url ? `<img src="${w.image_url}" style="max-width: 100%; border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">` : ''}
                        ${w.content || 'Image question'}
                    </div>
                    
                    ${w.knowledge_point ? `
                        <div style="margin-bottom: var(--spacing-sm);">
                            <span class="tag tag-info" style="font-size: 12px;">ðŸ’¡ ${w.knowledge_point}</span>
                        </div>
                    ` : ''}
                    
                    <div class="wrong-answer">
                        <div class="wrong-answer-label">Correct Answer</div>
                        <div>${w.answer}</div>
                    </div>
                    
                    ${w.steps && w.steps.length > 0 ? `
                        <details style="margin-bottom: var(--spacing-md);">
                            <summary style="cursor: pointer; color: var(--primary); font-weight: 500;">View Solution Steps</summary>
                            <ul class="steps-list" style="margin-top: var(--spacing-md);">
                                ${w.steps.map((step, i) => `
                                    <li class="step-item">
                                        <span class="step-number">${i + 1}</span>
                                        <div class="step-content">${step}</div>
                                    </li>
                                `).join('')}
                            </ul>
                        </details>
                    ` : ''}
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-md);">
                        <span style="color: var(--text-secondary); font-size: 13px;">
                            Practiced <strong>${w.practice_count}</strong> times
                        </span>
                    </div>
                    
                    <div class="wrong-actions">
                        <button class="btn btn-secondary btn-sm" onclick="practice(${w.id})">
                            <i class="fas fa-redo"></i>
                            Practice Again
                        </button>
                        <button class="btn btn-sm" style="background: var(--success); color: white;" onclick="master(${w.id})">
                            <i class="fas fa-check"></i>
                            Mastered
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Search and filter function
function filterWrongBook() {
    const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
    const subjectFilter = document.getElementById('subjectFilter').value;
    
    let filtered = allWrongQuestions;
    
    // Filter by subject
    if (subjectFilter) {
        filtered = filtered.filter(w => w.subject === subjectFilter);
    }
    
    // Search by keyword (search question content and knowledge points)
    if (searchText) {
        filtered = filtered.filter(w => {
            const content = (w.content || '').toLowerCase();
            const knowledge = (w.knowledge_point || '').toLowerCase();
            const answer = (w.answer || '').toLowerCase();
            return content.includes(searchText) || 
                   knowledge.includes(searchText) || 
                   answer.includes(searchText);
        });
    }
    
    renderWrongBook(filtered);
    updateFilterStats(filtered.length, allWrongQuestions.length);
}

// Update statistics info
function updateFilterStats(filtered, total) {
    const statsEl = document.getElementById('filterStats');
    if (filtered === total) {
        statsEl.innerHTML = `Total <strong>${total}</strong> questions`;
    } else {
        statsEl.innerHTML = `Showing <strong>${filtered}</strong> questions, total <strong>${total}</strong>`;
    }
}

// Clear filter
function clearFilter() {
    document.getElementById('searchInput').value = '';
    document.getElementById('subjectFilter').value = '';
    filterWrongBook();
}

// Practice again - redirect to practice page
function practice(wrongId) {
    window.location.href = `/practice-en?id=${wrongId}`;
}

// Mark as mastered
async function master(wrongId) {
    try {
        await api(`/api/wrong-book/master/${wrongId}`, { method: 'POST' });
        showToast('Great! Marked as mastered!', 'success');
        
        // Remove from pending list
        const wrongCard = document.getElementById(`wrong-${wrongId}`);
        if (wrongCard) {
            wrongCard.remove();
        }
        
        // Reload data to update mastered section
        loadWrongBook();
        loadMasteredQuestions();
    } catch (error) {
        // Error already handled
    }
}

// Load mastered questions
async function loadMasteredQuestions() {
    try {
        const mastered = await api('/api/wrong-book/mastered');
        const masteredSection = document.getElementById('masteredSection');
        const masteredCount = document.getElementById('masteredCount');
        const masteredList = document.getElementById('masteredList');
        
        masteredCount.textContent = mastered.length;
        
        if (mastered.length > 0) {
            masteredSection.style.display = 'block';
            
            masteredList.innerHTML = `
                <div class="wrong-book-grid">
                    ${mastered.map(w => `
                        <div class="card wrong-card" style="opacity: 0.9;">
                            <div class="wrong-card-header">
                                <span class="tag" style="background: var(--success);">${w.subject || 'Uncategorized'}</span>
                                <span class="wrong-subject">${new Date(w.created_at).toLocaleDateString()}</span>
                            </div>
                            
                            <div class="wrong-content">
                                ${w.image_url ? `<img src="${w.image_url}" style="max-width: 100%; border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">` : ''}
                                ${w.content || 'Image question'}
                            </div>
                            
                            ${w.knowledge_point ? `
                                <div style="margin-bottom: var(--spacing-sm);">
                                    <span class="tag tag-info" style="font-size: 12px;">ðŸ’¡ ${w.knowledge_point}</span>
                                </div>
                            ` : ''}
                            
                            <div class="wrong-answer">
                                <div class="wrong-answer-label">Correct Answer</div>
                                <div>${w.answer}</div>
                            </div>
                            
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-md);">
                                <span style="color: var(--text-secondary); font-size: 13px;">
                                    Practiced <strong>${w.practice_count}</strong> times
                                </span>
                                <span class="tag" style="background: var(--success); color: white; font-size: 12px;">âœ… Mastered</span>
                            </div>
                            
                            <div class="wrong-actions">
                                <button class="btn btn-ghost btn-sm" onclick="practice(${w.id})">
                                    <i class="fas fa-eye"></i>
                                    View Details
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            masteredSection.style.display = 'none';
        }
    } catch (error) {
        console.error(error);
    }
}

// Toggle mastered section display
function toggleMastered() {
    const content = document.getElementById('masteredContent');
    const icon = document.getElementById('masteredToggleIcon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

// Execute on page load
loadWrongBook();
loadMasteredQuestions();
</script>
{% endblock %}
