{% extends "layout.html" %}

{% block title %}å­¦ä¹ ä¸­å¿ƒ - æ™ºæ…§æ•™è‚²å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ‘‹ ä½ å¥½ï¼Œ{{ user.username }}ï¼</h1>
    <p class="page-subtitle">ä»Šå¤©æƒ³å­¦ç‚¹ä»€ä¹ˆï¼Ÿé€‰æ‹©ä¸‹é¢çš„åŠŸèƒ½å¼€å§‹å§</p>
</div>

<!-- å¿«æ·åŠŸèƒ½å¡ç‰‡ -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-xl); margin-bottom: var(--spacing-2xl);">
    <a href="/question" class="card" style="text-decoration: none; cursor: pointer; transition: transform 0.3s;">
        <div style="text-align: center;">
            <div style="font-size: 56px; margin-bottom: var(--spacing-md);">ğŸ“¸</div>
            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">æ‹ç…§è§£é¢˜</h3>
            <p style="color: var(--text-secondary); font-size: 14px;">æ‹ç…§æˆ–è¾“å…¥é¢˜ç›®ï¼ŒAIå¸®ä½ è¯¦ç»†è§£ç­”</p>
        </div>
    </a>
    
    <a href="/essay" class="card" style="text-decoration: none; cursor: pointer;">
        <div style="text-align: center;">
            <div style="font-size: 56px; margin-bottom: var(--spacing-md);">âœï¸</div>
            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">ä½œæ–‡æ‰¹æ”¹</h3>
            <p style="color: var(--text-secondary); font-size: 14px;">æäº¤ä½œæ–‡ï¼Œè·å¾—ä¸“ä¸šæ‰¹æ”¹å»ºè®®</p>
        </div>
    </a>
    
    <a href="/chat" class="card" style="text-decoration: none; cursor: pointer;">
        <div style="text-align: center;">
            <div style="font-size: 56px; margin-bottom: var(--spacing-md);">ğŸ’¬</div>
            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">å­¦ä¹ åŠ©æ‰‹</h3>
            <p style="color: var(--text-secondary); font-size: 14px;">æœ‰é—®å¿…ç­”ï¼Œä½ çš„ä¸“å±å­¦ä¹ ä¼™ä¼´</p>
        </div>
    </a>
</div>

<!-- å­¦ä¹ æ¦‚è§ˆ -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-xl);">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ“Š æœ¬å‘¨å­¦ä¹ æ¦‚è§ˆ</h3>
        </div>
        <div id="statsOverview" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-lg);">
            <div style="text-align: center; padding: var(--spacing-lg); background: var(--bg-primary); border-radius: var(--radius-md);">
                <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="statQuestions">-</div>
                <div style="color: var(--text-secondary); font-size: 14px;">è§£ç­”é¢˜ç›®</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-lg); background: var(--bg-primary); border-radius: var(--radius-md);">
                <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="statAccuracy">-</div>
                <div style="color: var(--text-secondary); font-size: 14px;">æ­£ç¡®ç‡</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-lg); background: var(--bg-primary); border-radius: var(--radius-md);">
                <div style="font-size: 32px; font-weight: 700; color: var(--purple);" id="statEssays">-</div>
                <div style="color: var(--text-secondary); font-size: 14px;">ä½œæ–‡æ‰¹æ”¹</div>
            </div>
            <div style="text-align: center; padding: var(--spacing-lg); background: var(--bg-primary); border-radius: var(--radius-md);">
                <div style="font-size: 32px; font-weight: 700; color: var(--secondary);" id="statMastered">-</div>
                <div style="color: var(--text-secondary); font-size: 14px;">å·²æŒæ¡</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">âš ï¸ è–„å¼±çŸ¥è¯†ç‚¹</h3>
        </div>
        <ul class="weak-points-list" id="weakPointsList">
            <li class="weak-point-item">
                <span class="weak-point-name">åŠ è½½ä¸­...</span>
            </li>
        </ul>
    </div>
</div>

<!-- æœ€è¿‘è®°å½• -->
<div class="card" style="margin-top: var(--spacing-xl);">
    <div class="card-header">
        <h3 class="card-title">ğŸ“ æœ€è¿‘å­¦ä¹ è®°å½•</h3>
        <a href="/statistics" class="btn btn-ghost btn-sm">æŸ¥çœ‹å…¨éƒ¨</a>
    </div>
    <div id="recentHistory">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">åŠ è½½ä¸­...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStats() {
    try {
        const stats = await api('/api/statistics');
        document.getElementById('statQuestions').textContent = stats.recent_questions;
        document.getElementById('statAccuracy').textContent = stats.accuracy_rate + '%';
        document.getElementById('statEssays').textContent = stats.essay_count;
        document.getElementById('statMastered').textContent = stats.mastered_count;
        
        // è–„å¼±çŸ¥è¯†ç‚¹
        const weakList = document.getElementById('weakPointsList');
        if (stats.weak_points.length > 0) {
            weakList.innerHTML = stats.weak_points.map(wp => `
                <li class="weak-point-item">
                    <span class="weak-point-name">${wp.name}</span>
                    <span class="weak-point-count">${wp.count}é¢˜</span>
                </li>
            `).join('');
        } else {
            weakList.innerHTML = '<li class="weak-point-item"><span class="weak-point-name" style="color: var(--success);">æš‚æ— è–„å¼±çŸ¥è¯†ç‚¹ ğŸ‘</span></li>';
        }
    } catch (error) {
        console.error(error);
    }
}

// åŠ è½½æœ€è¿‘è®°å½•
async function loadHistory() {
    try {
        const data = await api('/api/history?limit=5');
        const container = document.getElementById('recentHistory');
        
        if (data.items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <p class="empty-title">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</p>
                    <p class="empty-text">å¼€å§‹æé—®æˆ–ç»ƒä¹ å§ï¼</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = data.items.map(item => `
            <div style="display: flex; align-items: center; padding: var(--spacing-md) 0; border-bottom: 1px solid var(--border);">
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 4px;">${item.content ? item.content.substring(0, 50) + '...' : 'å›¾ç‰‡é¢˜ç›®'}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">
                        <span class="tag tag-info" style="margin-right: 8px;">${item.subject}</span>
                        ${new Date(item.created_at).toLocaleString()}
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error(error);
    }
}

loadStats();
loadHistory();
</script>
{% endblock %}
